<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Protection Configurator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://animatedicons.co/scripts/embed-animated-icons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        :root {
            --color-background: #0A0A0A;
            --color-text: #EAEAEA;
            --color-text-muted: #888888;
            --color-primary: #FFB700;
            --color-surface: #141414;
            --color-border: #2A2A2A;
            --color-danger: #ff4d4d;
            --color-success: #4ade80;
            --font-heading: 'Rajdhani', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        /* General Styles */
        html {
            box-sizing: border-box;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }
        body {
            background-color: var(--color-background);
            color: var(--color-text);
            font-family: var(--font-body);
            line-height: 1.6;
            padding: 2rem 1rem;
            margin: 0;
        }

        h1, h2, h3 {
            font-family: var(--font-heading);
            text-transform: uppercase;
            font-weight: 700;
            color: white;
            line-height: 1.2;
        }
        
        .widget-container {
            width: 100%;
            max-width: 1280px;
            margin: 0 auto;
            display: flex;
            gap: 2rem;
            align-items: flex-start;
        }

        #image-display-container {
            flex: 1 1 40%;
            position: sticky;
            top: 50vh;
            transform: translateY(-50%);
            text-align: center;
            position: relative;
        }
        #coverage-image-base, #coverage-image-overlay {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            transition: all 0.3s ease;
            object-fit: contain;
        }
        #coverage-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            pointer-events: none;
        }


        #configurator-wrapper {
            flex: 1 1 60%;
            min-width: 0;
        }

        .panel {
            background-color: var(--color-surface);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 0 0 1.5rem 0;
            border: 1px solid var(--color-border);
        }
        
        .form-step, #welcome-container, #thank-you-container {
            display: none;
        }
        .form-step.active, #welcome-container.active, #thank-you-container.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .step-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .step-header h2 {
            font-size: 2.25rem;
            margin-top: 0;
            margin-bottom: 0.25rem;
        }

        .step-header p {
            color: var(--color-text-muted);
            font-size: 1rem;
            margin-top: 0;
        }

        .header-subtext-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 0.5rem 1rem;
        }
        
        .progress-bar {
            position: relative;
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            margin-left: auto;
            margin-right: auto;
            max-width: 900px;
            padding: 0 1rem;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 4px;
            left: var(--bar-start-offset, 10%);
            width: var(--bar-width, 80%);
            height: 2px;
            background-color: var(--color-border);
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 4px;
            left: var(--bar-start-offset, 10%);
            width: var(--progress-width, 0%);
            height: 2px;
            background-color: var(--color-primary);
            transition: width 0.4s ease-in-out;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            font-family: var(--font-heading);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text-muted);
            transition: color 0.3s ease;
            cursor: default;
            padding-top: 20px;
        }
        
        .step-node {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 10px;
            background-color: var(--color-background);
            border: 2px solid var(--color-border);
            border-radius: 2px;
            transition: all 0.3s ease;
            z-index: 1;
        }
        
        .progress-step.completed { color: var(--color-text); }
        .progress-step.completed .step-node { background-color: var(--color-primary); border-color: var(--color-primary); }
        .progress-step.active { color: var(--color-primary); }
        .progress-step.active .step-node { border-color: var(--color-primary); }

        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block;
            margin-bottom: .5rem;
            font-weight: 600;
            font-family: var(--font-heading);
            font-size: 1.1rem;
            text-transform: uppercase;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            background-color: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text);
            font-size: 1rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
            flex-grow: 1;
        }
        .form-control:focus { outline: none; border-color: var(--color-primary); }
        
        .choice-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
        }

        /* Service Tabs */
        .service-tabs-container {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }

        .service-tab {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            font-family: var(--font-heading);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text-muted);
            background-color: transparent;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .service-tab.available:hover {
             color: var(--color-text);
             background-color: var(--color-border);
        }

        .service-tab.selected {
            background-color: var(--color-primary);
            color: var(--color-background);
            font-weight: 700;
            padding-right: 30px; /* Space for the X */
        }
        .service-tab.viewing {
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-primary);
            border-radius: 6px 6px 0 0;
        }
         .service-tab.selected.viewing {
            background-color: transparent;
            color: var(--color-primary);
        }

        .service-tab .close-btn {
            display: none;
            position: absolute;
            top: 50%;
            right: 6px;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: var(--color-background);
            cursor: pointer;
            z-index: 2;
            border-radius: 50%;
        }
        .service-tab .close-btn:hover {
            background-color: rgba(0,0,0,0.2);
        }
        
        .service-tab.selected .close-btn {
            display: block;
        }
        .service-tab.selected.viewing .close-btn {
            color: var(--color-text);
        }
        .service-tab.selected.viewing .close-btn:hover {
            background-color: var(--color-border);
        }

        .choice-input { display: none; }
        .choice-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 14px;
            font-family: var(--font-heading);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text);
            background-color: transparent;
            border: 2px solid var(--color-border);
            position: relative;
            transition: color 0.4s ease-in-out, background-color 0.4s ease-in-out;
            cursor: pointer;
            text-align: center;
            min-height: 40px;
            border-radius: 6px;
        }
        .choice-input:checked + .choice-label {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-background);
            font-weight: 700;
        }
        
        .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            gap: 1rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 20px;
            font-family: var(--font-heading);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text);
            background-color: transparent;
            border: 2px solid var(--color-border);
            position: relative;
            overflow: hidden;
            transition: color 0.4s ease-in-out, background-color 0.4s ease-in-out, border-color 0.4s ease-in-out;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            flex-grow: 1;
            gap: 0.5rem;
            z-index: 1;
            border-radius: 6px;
        }
        .btn span, .choice-label span, .btn i, .btn animated-icons {
            position: relative;
            z-index: 2;
        }
        .btn span {
            top: 1px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background-color: var(--color-primary);
            transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: -1;
        }
        
        .btn-primary {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }
        .btn-primary:hover {
            color: var(--color-background);
            font-weight: 700;
            border-color: var(--color-primary);
        }
        .btn-primary:hover::before {
            width: 100%;
        }

        .btn:disabled {
            border-color: var(--color-border);
            color: var(--color-text-muted);
            cursor: not-allowed;
            background-color: var(--color-surface);
        }
        
        .hidden-field { display: none !important; }

        .estimate-summary { 
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .summary-main {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }

        .summary-total {
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 0.5rem;
        }

        .estimate-summary h3 { font-size: 1.25rem; margin: 0; }

        .estimate-summary .total-price { font-size: 1.75rem; font-weight: 700; color: var(--color-primary); }
        .estimate-summary .total-price.consultation { color: #888888; font-size: 1.25rem; }
        
        #toggle-summary-btn {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: 5px;
            transition: transform 0.3s ease;
            line-height: 1;
        }

        #toggle-summary-btn.expanded {
            transform: rotate(180deg);
        }

        #summary-breakdown {
            width: 100%;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding-top 0.5s ease-in-out, margin-top 0.5s ease-in-out;
        }

        #summary-breakdown.expanded {
            border-top: 1px solid var(--color-border);
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            max-height: 500px;
        }

        #summary-items-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
            font-size: 0.9rem;
        }

        #summary-items-list li {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }

        #summary-items-list li:not(:last-child) {
            border-bottom: 1px solid var(--color-background);
        }

        #summary-items-list .item-name {
            color: var(--color-text);
            padding-right: 1rem;
        }
        
        #summary-items-list .item-name.discount {
            color: var(--color-success);
        }

        #summary-items-list .item-price {
            color: var(--color-primary);
            font-weight: 600;
            white-space: nowrap;
        }

        #summary-items-list .item-price.discount {
            color: var(--color-success);
        }

        .call-link-container {
            position: relative;
            display: inline-flex;
            justify-content: center;
        }
        
        .call-link {
            display: inline-flex;
            align-items: center;
            color: var(--color-primary);
            text-decoration: none;
            font-family: var(--font-body);
            font-size: 0.9rem;
            transition: color 0.3s ease;
            text-transform: none;
        }
        .call-link:hover { color: var(--color-text); }
        .call-link animated-icons { width: 22px !important; height: 22px !important; margin-right: 6px; }
        .qr-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            margin-bottom: 12px;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 0.75rem;
            z-index: 10;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
            pointer-events: none;
            width: auto;
        }
        .qr-tooltip.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }
        .qr-tooltip::before, .info-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px;
            border-style: solid;
            border-color: var(--color-border) transparent transparent transparent;
        }
        .qr-tooltip::after, .info-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: -1px;
            border-width: 7px;
            border-style: solid;
            border-color: var(--color-surface) transparent transparent transparent;
        }
        
        .info-tooltip-container {
            position: relative;
        }

        .info-tooltip-container .info-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-15px);
            margin-bottom: 5px;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            z-index: 20;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            width: max-content;
            font-size: 0.85rem;
            color: var(--color-text);
            font-family: var(--font-body);
            text-transform: none;
            font-weight: 400;
        }
        .info-tooltip-container:hover .info-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
        }

        /* --- Slider Styles --- */
        .slider-container { padding: 1rem 0.5rem; }
        .tint-slider, .hue-slider, .budget-slider-input {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: var(--color-border);
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            border-radius: 2px;
            margin: 0;
        }

        .tint-slider:hover, .hue-slider:hover, .budget-slider-input:hover { opacity: 1; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 77, 77, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); }
        }

        .tint-slider::-webkit-slider-thumb, .hue-slider::-webkit-slider-thumb, .budget-slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-primary);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid var(--color-surface);
            margin-top: -8px; 
            transition: box-shadow 0.3s ease;
        }
        .tint-slider.illegal-tint::-webkit-slider-thumb {
            background-color: var(--color-danger);
            animation: pulse-red 2s infinite;
        }
        .tint-slider::-moz-range-thumb, .hue-slider::-moz-range-thumb, .budget-slider-input::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--color-primary);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid var(--color-surface);
            transition: box-shadow 0.3s ease;
        }
        .tint-slider.illegal-tint::-moz-range-thumb {
            background-color: var(--color-danger);
            box-shadow: 0 0 8px var(--color-danger);
        }
        .hue-slider::-webkit-slider-thumb { background: #EAEAEA; }
        .hue-slider::-moz-range-thumb { background: #EAEAEA; }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            padding: 0 5px;
            margin-top: 0.75rem;
        }

        .slider-label {
            color: var(--color-text-muted);
            font-size: 0.8rem;
            font-family: var(--font-heading);
            font-weight: 600;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.3s ease;
        }

        /* --- Integrated Package Slider Styles --- */
        .package-slider-container { color: var(--color-text); }
        
        .package-card {
            background-color: var(--color-background) !important;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            transition: all 0.3s ease;
            transform: scale(0.95);
            opacity: 0.7;
        }
        .package-card.active {
            transform: scale(1);
            opacity: 1;
            border-color: var(--color-primary) !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .protection-meter-bg {
            background-color: var(--color-border);
        }
        
        .protection-meter-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(255, 183, 0, 0.5);
            transition: width 0.4s ease-out;
        }
        .package-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-family: var(--font-heading);
            text-transform: uppercase;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            width: 100%;
            background-color: var(--color-primary);
            color: var(--color-background) !important;
            border: 2px solid transparent;
        }
        .package-btn:hover {
            background-color: #ffc733; /* Lighter yellow */
        }
        .parts-toggle-btn {
             background-color: var(--color-surface);
             border: 1px solid var(--color-border);
             color: var(--color-text);
        }
         .parts-toggle-btn:hover {
             background-color: var(--color-border);
         }

        @media (max-width: 992px) {
             .widget-container {
                 flex-direction: column;
            }
            #image-display-container {
                position: static;
                transform: none;
                width: 100%;
                max-width: 40%;
                margin-left: auto;
                margin-right: auto;
                margin-bottom: 2rem;
            }
        }
        @media (max-width: 640px) {
            body { padding: 1rem 0; }
            .panel { padding: 1rem; }
            .step-header h2 { font-size: 2rem; }
            .btn-group { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div class="widget-container">
        <!-- Image Display Area -->
        <div id="image-display-container">
            <img id="coverage-image-base" src="https://cdn.shopify.com/s/files/1/0671/4635/0805/files/image.png?v=1757352859" alt="Vehicle Protection Coverage Example">
            <img id="coverage-image-overlay" src="" alt="" style="display: none;">
        </div>

        <div id="configurator-wrapper">
            <!-- Multi-Step Form -->
            <div id="questionnaire-container" class="active">
                <div class="progress-bar" id="progress-bar">
                    <div class="progress-step active" data-step="1"><div class="step-node"></div>Selections</div>
                    <div class="progress-step" data-step="2"><div class="step-node"></div>Contact</div>
                </div>
                
                <form id="configurator-form">
                    <!-- Step 1: Vehicle Type and Services -->
                    <div id="step-1" class="form-step active">
                        <div class="panel">
                            <div class="step-header">
                                <h2>VEHICLE PROTECTION CONFIGURATOR</h2>
                                <div class="header-subtext-container">
                                    <p id="welcome-message">Tell us what you drive and what you'd like to protect.</p>
                                    <div class="call-link-container" id="call-link-welcome">
                                        <a href="tel:4696251127" class="call-link">
                                            <animated-icons src="https://animatedicons.co/get-icon?name=Calling%20V3&style=minimalistic&token=66ff3706-138c-41fa-a993-dee03566e48c" trigger="loop" attributes='{"variationThumbColour":"#FFB700","variationName":"Dark","variationNumber":4,"numberOfGroups":2,"strokeWidth":1.5,"backgroundIsGroup":true,"defaultColours":{"group-1":"#FFB700","group-2":"#FFB700","background":"#0A0A0A"}}' height="22" width="22"></animated-icons>
                                            <span>or give us a ring, we're open!</span>
                                        </a>
                                        <div class="qr-tooltip">
                                            <canvas class="qr-code-canvas"></canvas>
                                            <p>Scan to call us!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="estimate-summary">
                                <div class="summary-main">
                                    <div class="summary-total">
                                        <h3>Starting At:</h3>
                                        <div id="price-display" class="total-price">$0.00</div>
                                    </div>
                                    <button type="button" id="toggle-summary-btn" class="hidden-field" title="View Details">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                                <div id="summary-breakdown">
                                    <ul id="summary-items-list"></ul>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Vehicle Type</label>
                                <div class="choice-group">
                                    <div><input type="radio" id="vehicle-2door" name="vehicle" value="2Door" class="choice-input" checked><label for="vehicle-2door" class="choice-label"><span>2 Door</span></label></div>
                                    <div><input type="radio" id="vehicle-4door" name="vehicle" value="4Door" class="choice-input"><label for="vehicle-4door" class="choice-label"><span>4 Door</span></label></div>
                                    <div><input type="radio" id="vehicle-suv" name="vehicle" value="SUV" class="choice-input"><label for="vehicle-suv" class="choice-label"><span>SUV</span></label></div>
                                    <div><input type="radio" id="vehicle-oversize" name="vehicle" value="Oversize" class="choice-input"><label for="vehicle-oversize" class="choice-label"><span>Oversize</span></label></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Services</label>
                                <div class="service-tabs-container" id="service-tabs-container">
                                    <!-- Tabs will be dynamically controlled by JS -->
                                </div>
                            </div>
                            <div id="dynamic-services-container"></div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary next-btn btn-right" id="selections-next-btn" disabled>
                                    <span>Continue to Contact</span>
                                    <animated-icons src="https://animatedicons.co/get-icon?name=Forward&style=minimalistic&token=61ef98d6-f61b-49ac-a0f3-46fec965e300" trigger="loop" attributes='{"variationThumbColour":"#FFB700","variationName":"Dark","variationNumber":4,"numberOfGroups":2,"strokeWidth":1.5,"backgroundIsGroup":true,"defaultColours":{"group-1":"#FFB700","group-2":"#FFB700","background":"#0A0A0A"}}' height="22" width="22"></animated-icons>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Contact Information -->
                    <div id="step-2" class="form-step">
                        <div class="panel">
                            <div class="step-header"><h2>Contact an Expert</h2><p>Please provide your information below so we can get in touch.</p></div>
                            <div class="form-group">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label for="customer-first-name">First Name</label>
                                        <input type="text" id="customer-first-name" name="customer_first_name" class="form-control" required placeholder="e.g., John">
                                    </div>
                                    <div>
                                        <label for="customer-last-name">Last Name</label>
                                        <input type="text" id="customer-last-name" name="customer_last_name" class="form-control" required placeholder="e.g., Doe">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="customer-phone">Phone Number</label>
                                <input type="tel" id="customer-phone" name="customer_phone" class="form-control" required placeholder="e.g., (469) 625-1127">
                            </div>
                            <div class="form-group">
                                <label for="customer-email">Email</label>
                                <input type="email" id="customer-email" name="customer_email" class="form-control" required placeholder="e.g., john.doe@example.com">
                            </div>
                            <div class="form-group">
                                <label for="customer-comments">Questions or Comments (Optional)</label>
                                <textarea id="customer-comments" name="customer_comments" class="form-control" rows="3" placeholder="e.g., I'd like to discuss a custom design..."></textarea>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn prev-btn btn-left" id="contact-back-btn">
                                    <animated-icons src="https://animatedicons.co/get-icon?name=Back&style=minimalistic&token=7a22709d-7dc4-4654-b0d6-df0167ffeb74" trigger="click" attributes='{"variationThumbColour":"#EAEAEA","variationName":"Dark","variationNumber":4,"numberOfGroups":2,"strokeWidth":1.5,"backgroundIsGroup":true,"defaultColours":{"group-1":"#EAEAEA","group-2":"#EAEAEA","background":"#0A0A0A"}}' height="22" width="22"></animated-icons>
                                    <span>Back to Selections</span>
                                </button>
                                <button type="button" class="btn btn-primary btn-right" id="submit-form-btn">
                                    <span>Send Inquiry</span>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Thank You Screen -->
            <div id="thank-you-container" class="hidden-field">
                <div class="panel" style="text-align: center;">
                    <div style="display: flex; justify-content: center;">
                        <animated-icons
                            src="https://animatedicons.co/get-icon?name=High%20Five&style=minimalistic&token=dfda27f9-e133-49e0-bf9e-4d952d0ab596"
                            trigger="loop"
                            attributes='{"variationThumbColour":"#FFB700","variationName":"Dark","variationNumber":4,"numberOfGroups":2,"strokeWidth":1.5,"backgroundIsGroup":true,"defaultColours":{"group-1":"#FFB700","group-2":"#EAEAEA","background":"#141414"}}'
                            height="200"
                            width="200">
                        </animated-icons>
                    </div>
                    <div class="step-header" style="margin-bottom: 1rem;">
                        <h2 id="thank-you-title" style="margin-bottom: 0.5rem;">Thanks, <span class="user-name"></span>!</h2>
                        <p id="thank-you-subtitle">We're excited to help you protect your ride.</p>
                    </div>
                    <div class="call-link-container" id="call-link-thank-you" style="justify-content: center;">
                           <a href="tel:4696251127" class="call-link">
                                <animated-icons
                                    src="https://animatedicons.co/get-icon?name=Calling%20V3&style=minimalistic&token=66ff3706-138c-41fa-a993-dee03566e48c"
                                    trigger="loop"
                                    attributes='{"variationThumbColour":"#FFB700","variationName":"Dark","variationNumber":4,"numberOfGroups":2,"strokeWidth":1.5,"backgroundIsGroup":true,"defaultColours":{"group-1":"#FFB700","group-2":"#FFB700","background":"#0A0A0A"}}'
                                    height="22"
                                    width="22">
                                </animated-icons>
                                <span>Want to discuss your build now? Give us a ring, we’re open!</span>
                            </a>
                            <div class="qr-tooltip">
                                <canvas class="qr-code-canvas"></canvas>
                                <p>Scan to call us!</p>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATOR DATA ---
            const phoneNumber = '4696251127';
            // NOTE: Base pricing data is modified by augmentPricingData() on init to add addon structures for packages.
            let pricingData = {
                '2Door': {
                    'PPF': { 'Partial': { price: 600.00 }, 'Full Front': { price: 2495.00 }, 'Track Pack': { price: 3295.00 }, 'Full Car': { price: 6295.00 } },
                    'Tint': { 'Rollups': { price: 175.00, options: { '80%': 0, '35%': { price: 0, tooltip: 'Legal limit in TX for front windows' }, '20%': 0, '5%': 0 } }, 'Full Car': { price: 495.00, options: { '80%': 0, '35%': { price: 0, tooltip: 'Legal limit in TX for front windows' }, '20%': 0, '5%': 0 } }, 'Windshield': { price: 450.00, options: { '80%': 0, '35%': { price: 0, tooltip: 'Legal limit in TX for front windows' }, '20%': 0, '5%': 0 } } },
                    'Coating': { 'Paint': { base: 'Requires 1 box checked', options: { '1 Step Polish': 995.00, '2 Step Polish/PC': 1295.00, '3+ Step Polish/PC': 'Call For Free Consultation' } }, 'Wheels': { base: 'Requires 1 box checked', options: { 'Face Only': 200.00, 'Face & Barrels': 400.00 } }, 'Windshield': { price: 155.00 } },
                    'Vinyl': { 'Color Change': { price: 3495.00 }, 'Custom Graphic': { price: 'Call For Free Consultation' } }
                },
                '4Door': {
                    'PPF': { 'Partial': { price: 600.00 }, 'Full Front': { price: 2495.00 }, 'Track Pack': { price: 3295.00 }, 'Full Car': { price: 7095.00 } },
                    'Tint': { 'Rollups': { price: 175.00, options: { '80%': 0, '35%': { price: 0, tooltip: 'Legal limit in TX for front windows' }, '20%': 0, '5%': 0 } }, 'Full Car': { price: 595.00, options: { '80%': 0, '35%': { price: 0, tooltip: 'Legal limit in TX for front windows' }, '20%': 0, '5%': 0 } }, 'Windshield': { price: 450.00, options: { '80%': 0, '35%': { price: 0, tooltip: 'Legal limit in TX for front windows' }, '20%': 0, '5%': 0 } } },
                    'Coating': { 'Paint': { base: 'Requires 1 box checked', options: { '1 Step Polish': 1195.00, '2 Step Polish/PC': 1545.00, '3+ Step Polish/PC': 'Call For Free Consultation' } }, 'Wheels': { base: 'Requires 1 box checked', options: { 'Face Only': 200.00, 'Face & Barrels': 400.00 } }, 'Windshield': { price: 155.00 } },
                    'Vinyl': { 'Color Change': { price: 3995.00 }, 'Custom Graphic': { price: 'Call For Free Consultation' } }
                },
                'SUV': {
                    'PPF': { 'Partial': { price: 600.00 }, 'Full Front': { price: 2495.00 }, 'Track Pack': { price: 3295.00 }, 'Full Car': { price: 7895.00 } },
                    'Tint': { 'Rollups': { price: 175.00, options: { '80%': 0, '35%': { price: 0, tooltip: 'Legal limit in TX for front windows' }, '20%': 0, '5%': 0 } }, 'Full Car': { price: 645.00, options: { '80%': 0, '35%': { price: 0, tooltip: 'Legal limit in TX for front windows' }, '20%': 0, '5%': 0 } }, 'Windshield': { price: 450.00, options: { '80%': 0, '35%': { price: 0, tooltip: 'Legal limit in TX for front windows' }, '20%': 0, '5%': 0 } } },
                    'Coating': { 'Paint': { base: 'Requires 1 box checked', options: { '1 Step Polish': 1395.00, '2 Step Polish/PC': 1795.00, '3+ Step Polish/PC': 'Call For Free Consultation' } }, 'Wheels': { base: 'Requires 1 box checked', options: { 'Face Only': 200.00, 'Face & Barrels': 400.00 } }, 'Windshield': { price: 115.00 } },
                    'Vinyl': { 'Color Change': { price: 4295.00 }, 'Custom Graphic': { price: 'Call For Free Consultation' } }
                },
                'Oversize': {
                    'PPF': { 'Partial': { price: 600.00 }, 'Full Front': { price: 2495.00 }, 'Track Pack': { price: 3295.00 }, 'Full Car': { price: 8795.00 } },
                    'Tint': { 'Rollups': { price: 175.00, options: { '80%': 0, '35%': { price: 0, tooltip: 'Legal limit in TX for front windows' }, '20%': 0, '5%': 0 } }, 'Full Car': { price: 695.00, options: { '80%': 0, '35%': { price: 0, tooltip: 'Legal limit in TX for front windows' }, '20%': 0, '5%': 0 } }, 'Windshield': { price: 450.00, options: { '80%': 0, '35%': { price: 0, tooltip: 'Legal limit in TX for front windows' }, '20%': 0, '5%': 0 } } },
                    'Coating': { 'Paint': { base: 'Requires 1 box checked', options: { '1 Step Polish': 1495.00, '2 Step Polish/PC': 1995.00, '3+ Step Polish/PC': 'Call For Free Consultation' } }, 'Wheels': { base: 'Requires 1 box checked', options: { 'Face Only': 200.00, 'Face & Barrels': 400.00 } }, 'Windshield': { price: 155.00 } },
                    'Vinyl': { 'Color Change': { price: 4995.00 }, 'Custom Graphic': { price: 'Call For Free Consultation' } }
                }
            };
            
            const ppfImageMap = {
                'Partial': 'https://cdn.shopify.com/s/files/1/0671/4635/0805/files/image.png?v=1757352859', // Default/Partial Image
                'Full Front': 'https://cdn.shopify.com/s/files/1/0671/4635/0805/files/Full_Front.png?v=1757627749',
                'Track Pack': 'https://cdn.shopify.com/s/files/1/0671/4635/0805/files/Track_Pack.png?v=1757627748',
                'Full Car': 'https://cdn.shopify.com/s/files/1/0671/4635/0805/files/Full_coverage.png?v=1757627748'
            };

            const allServices = ['Packages', 'PPF', 'Tint', 'Coating', 'Vinyl'];
            let servicesState = {};
            let currentlyViewingService = null;
            let userSelections = { selectedItems: [] };
            let currentStep = 1;
            let userFirstName = '';
            let selectedPackageId = null;

            // --- PACKAGE SLIDER DATA ---
            const packages = [
                { id: 'tint-full', name: 'Full Car Tint', tagline: 'Interior Protection from UV Rays and Heat', description: 'NanoCeramic Window Tint for the Full Vehicle.', tag: 'Tint', ppfCoverage: null, protectionLevel: 10, prices: { '2Door': 495, '4Door': 595, 'SUV': 595, 'Oversize': 'call' }, discounts: [] },
                { id: 'tint-complete', name: 'Complete Tint', tagline: 'Upgraded comfort and UV defense.', description: 'NanoCeramic Window Tint for the Full Vehicle and Windshield.', tag: 'Tint', ppfCoverage: null, protectionLevel: 15, prices: { '2Door': 945, '4Door': 1045, 'SUV': 1045, 'Oversize': 'call' }, discounts: [] },
                { id: 'coating-essential', name: 'Essential Paint Coating', tagline: 'Gloss and protection where it matters most.', description: 'Includes Single Stage Polish & Paint Coating Installation. Additional Paint Correction Optional.', tag: 'Coating', ppfCoverage: null, protectionLevel: 25, prices: { '2Door': 995, '4Door': 1195, 'SUV': 1395, 'Oversize': 1695 }, discounts: [] },
                { id: 'tint-panoramic', name: 'Panoramic Tint', tagline: 'Total heat and UV rejection from every angle.', description: 'NanoCeramic Window Tint for the Full Vehicle, Windshield, and Sunroof.', tag: 'Tint', ppfCoverage: null, protectionLevel: 20, prices: { '2Door': 1240, '4Door': 1340, 'SUV': 1340, 'Oversize': 'call' }, discounts: [] },
                { id: 'coating-advanced', name: 'Advanced Exterior Coating', tagline: 'Exterior Protection Beyond Just Paint.', description: 'Includes Single Stage Polish & Paint, Full Wheel, and Windshield Coatings.', tag: 'Coating', ppfCoverage: null, protectionLevel: 40, prices: { '2Door': 1395, '4Door': 1595, 'SUV': 1795, 'Oversize': 2095 }, discounts: ['$150 Coating Bundle'] },
                { id: 'coating-ultimate', name: 'Ultimate Ceramic Package', tagline: 'Every surface shielded, inside and out.', description: 'Includes Full Vehicle Detail, as well as installation of Paint, Glass, Trim, Full Wheels, and Interior Coatings.', tag: 'Coating', ppfCoverage: null, protectionLevel: 55, prices: { '2Door': 1915, '4Door': 2245, 'SUV': 2595, 'Oversize': 2995 }, discounts: ['$150 Coating Bundle', 'FREE Trim Coating'] },
                { id: 'ppf-front', name: 'Full Front PPF', tagline: 'The Best Value in Impact Protection.', description: 'PPF Coverage on Front Bumper, Fenders, Hood, and Mirrors.', tag: 'PPF', ppfCoverage: 'Full Front', protectionLevel: 60, prices: { '2Door': 2495, '4Door': 2495, 'SUV': 2495, 'Oversize': 2495 }, discounts: [] },
                { id: 'bundle-essential', name: 'Essential Protection Package', tagline: 'Smart combo of PPF and coating for daily drivers.', description: 'Full Front PPF & Full body paint & ppf ceramic coating.', tag: 'Bundle', ppfCoverage: 'Full Front', protectionLevel: 70, prices: { '2Door': 3195, '4Door': 3395, 'SUV': 3595, 'Oversize': 3895 }, discounts: ['$295 PPF & Coating Bundle'] },
                { id: 'ppf-track', name: 'Track Package PPF', tagline: 'Extended high-impact coverage for spirited or daily driving.', description: 'PPF Coverage on Front Bumper, Fenders, Hood, Mirrors, Rocker Panels, A-Pillars, and a Roof Strip.', tag: 'PPF', ppfCoverage: 'Track Pack', protectionLevel: 75, prices: { '2Door': 3295, '4Door': 3295, 'SUV': 3295, 'Oversize': 3295 }, discounts: [] },
                { id: 'bundle-track-pro', name: 'Track Pro Package', tagline: 'Upgraded Protection Everywhere it Counts.', description: 'Track Pack PPF, Paint & PPF Coating, & Windshield Film.', tag: 'Bundle', ppfCoverage: 'Track Pack', protectionLevel: 80, prices: { '2Door': 4345, '4Door': 4545, 'SUV': 4745, 'Oversize': 5045 }, discounts: ['$295 PPF & Coating Bundle'] },
                { id: 'ppf-full', name: 'Full Car PPF', tagline: 'Complete Protection for Every Painted Surface.', description: 'Full Car PPF.', tag: 'PPF', ppfCoverage: 'Full Car', protectionLevel: 90, prices: { '2Door': 6495, '4Door': 7295, 'SUV': 7995, 'Oversize': 'call' }, discounts: [] },
                { id: 'bundle-gt3', name: 'GT3 Package', tagline: 'Complete Impact Protection & Weathering Resistance.', description: 'Full Car PPF, PPF Coating, & Windshield Film.', tag: 'Bundle', ppfCoverage: 'Full Car', protectionLevel: 95, prices: { '2Door': 7545, '4Door': 8545, 'SUV': 9445, 'Oversize': 'call' }, discounts: ['$295 PPF & Coating Bundle'] },
                { id: 'bundle-presidential', name: 'Presidential Package', tagline: 'Ultimate Peace of Mind.', description: 'Full Paint Restoration Prior to PPF Installation; Full car PPF; Windshield Film; PPF, Trim, Glass, Full Wheel, and Interior Coatings; Full Ceramic Window Tint Incl. Windshield & Sunroof.', tag: 'Bundle', ppfCoverage: 'Full Car', protectionLevel: 98, prices: { '2Door': 10405, '4Door': 11635, 'SUV': 12685, 'Oversize': 'call' }, discounts: ['$395 PPF, Tint, Coating Bundle', '$150 Coating Bundle', 'FREE Trim Coating'] },
                { id: 'bundle-f1', name: 'Formula 1 Package', tagline: 'No Compromises, Maximum Protection.', description: 'Full Paint Restoration Prior to PPF Installation; Track Package in 10 mil PPF with Full car 8 mil PPF on top; Windshield Film; PPF, Trim, Glass, Full Wheel, and Interior Coatings; Full Ceramic Window Tint Incl. Windshield & Sunroof.', tag: 'Bundle', ppfCoverage: 'Track Pack', isF1: true, protectionLevel: 100, prices: { '2Door': 13905, '4Door': 15135, 'SUV': 16185, 'Oversize': 'call' }, discounts: ['$395 PPF, Tint, Coating Bundle', '$150 Coating Bundle', 'FREE Trim Coating'] }
            ];

            // --- PACKAGE SELECTION MAPPING ---
            // Maps a package ID to the state selections it should trigger.
            const packageSelections = {
                'tint-full': { 'Tint': { selected: true, coverage: 'Full Car', addons: [], option: '1' } },
                'tint-complete': { 'Tint': { selected: true, coverage: 'Full Car', addons: ['Add Windshield'], option: '1' } },
                'coating-essential': { 'Coating': { selected: true, coverage: 'Paint', option: '1 Step Polish' } },
                'tint-panoramic': { 'Tint': { selected: true, coverage: 'Full Car', addons: ['Add Windshield', 'Add Sunroof'], option: '1' } },
                'coating-advanced': { 'Coating': { selected: true, coverage: 'Paint', option: '1 Step Polish', addons: ['Add Wheels (Face & Barrels)', 'Add Windshield'] } },
                'coating-ultimate': { 'Coating': { selected: true, coverage: 'Paint', option: '1 Step Polish', addons: ['Add Wheels (Face & Barrels)', 'Add Windshield'] } }, // Simplified, as interior/trim coatings aren't options
                'ppf-front': { 'PPF': { selected: true, coverage: 'Full Front' } },
                'bundle-essential': {
                    'PPF': { selected: true, coverage: 'Full Front' },
                    'Coating': { selected: true, coverage: 'Paint', option: '1 Step Polish' }
                },
                'ppf-track': { 'PPF': { selected: true, coverage: 'Track Pack' } },
                'bundle-track-pro': {
                    'PPF': { selected: true, coverage: 'Track Pack' },
                    'Coating': { selected: true, coverage: 'Paint', option: '1 Step Polish' },
                    'Tint': { selected: true, coverage: 'Windshield', option: '1' } // Assuming windshield film means windshield tint
                },
                'ppf-full': { 'PPF': { selected: true, coverage: 'Full Car' } },
                'bundle-gt3': {
                    'PPF': { selected: true, coverage: 'Full Car' },
                    'Coating': { selected: true, coverage: 'Paint', option: '1 Step Polish' }, // Assuming PPF coating is similar to paint coating
                    'Tint': { selected: true, coverage: 'Windshield', option: '1' }
                },
                'bundle-presidential': {
                    'PPF': { selected: true, coverage: 'Full Car' },
                    'Tint': { selected: true, coverage: 'Full Car', addons: ['Add Windshield', 'Add Sunroof'], option: '1' },
                    'Coating': { selected: true, coverage: 'Paint', option: '2 Step Polish/PC', addons: ['Add Wheels (Face & Barrels)', 'Add Windshield'] }
                },
                 'bundle-f1': {
                    'PPF': { selected: true, coverage: 'Track Pack' }, // Simplified - this is complex, making Track Pack the base
                    'Tint': { selected: true, coverage: 'Full Car', addons: ['Add Windshield', 'Add Sunroof'], option: '1' },
                    'Coating': { selected: true, coverage: 'Paint', option: '2 Step Polish/PC', addons: ['Add Wheels (Face & Barrels)', 'Add Windshield'] }
                }
            };
            
            const packageBreakdowns = {
                'bundle-presidential': {
                    '2Door': [
                        { name: 'Full Car PPF', price: 6295 },
                        { name: 'Windshield Protective Film', price: 350 },
                        { name: 'Full Tint (Car, Windshield, Sunroof)', price: 1240 },
                        { name: 'Paint Restoration', price: 1000 },
                        { name: 'Paint Coating', price: 995 },
                        { name: 'Full Wheel Coating', price: 400 },
                        { name: 'Full Glass Coating', price: 255 },
                        { name: 'Interior Coating', price: 415 },
                        { name: 'Trim Coating', price: 'Included' },
                        { name: 'PPF, Tint, & Coating Bundle', price: -395 },
                        { name: 'Coating Bundle', price: -150 }
                    ]
                    // Add breakdowns for 4Door, SUV etc. if they differ in components
                },
                'bundle-f1': {
                    '2Door': [
                        { name: 'Track Pack in 10 mil PPF', price: 3500 },
                        { name: 'Full Car 8 mil PPF', price: 6495 },
                        { name: 'Windshield Protective Film', price: 350 },
                        { name: 'Full Tint (Car, Windshield, Sunroof)', price: 1240 },
                        { name: 'Paint Restoration', price: 800 },
                        { name: 'Paint Coating', price: 995 },
                        { name: 'Full Wheel Coating', price: 400 },
                        { name: 'Full Glass Coating', price: 255 },
                        { name: 'Interior Coating', price: 415 },
                        { name: 'Trim Coating', price: 'Included' },
                        { name: 'PPF, Tint, & Coating Bundle', price: -395 },
                        { name: 'Coating Bundle', price: -150 }
                    ]
                }
            };


            const sliderMap = [
                { slider: 0,    budget: 0 },
                { slider: 100,  budget: 1500 },
                { slider: 300,  budget: 4000 },
                { slider: 700,  budget: 10000 },
                { slider: 1000, budget: 18000 }
            ];
            
            // --- UI & FORM ELEMENTS ---
            const form = document.getElementById('configurator-form');
            const welcomeMessageEl = document.getElementById('welcome-message');
            const nextBtns = document.querySelectorAll('.next-btn');
            const prevBtns = document.querySelectorAll('.prev-btn');
            const progressSteps = document.querySelectorAll('.progress-step');
            const progressBar = document.getElementById('progress-bar');
            const dynamicServicesContainer = document.getElementById('dynamic-services-container');
            const serviceTabsContainer = document.getElementById('service-tabs-container');
            const selectionsNextBtn = document.getElementById('selections-next-btn');
            const priceDisplay = document.getElementById('price-display');
            const thankYouContainer = document.getElementById('thank-you-container');
            const coverageImageBase = document.getElementById('coverage-image-base');
            const coverageImageOverlay = document.getElementById('coverage-image-overlay');
            const submitFormBtn = document.getElementById('submit-form-btn');
            const callLinks = document.querySelectorAll('.call-link');
            const summaryBreakdown = document.getElementById('summary-breakdown');
            const summaryItemsList = document.getElementById('summary-items-list');
            const toggleSummaryBtn = document.getElementById('toggle-summary-btn');
            const estimateSummaryEl = document.querySelector('.estimate-summary');

            // --- PACKAGE SLIDER HELPER FUNCTIONS ---
            function convertSliderValueToBudget(value) {
                const segment = sliderMap.find((point, index) => {
                    const nextPoint = sliderMap[index + 1];
                    return value >= point.slider && value <= (nextPoint ? nextPoint.slider : 1000);
                });
                const nextPoint = sliderMap[sliderMap.indexOf(segment) + 1];
                if (!nextPoint) return sliderMap[sliderMap.length - 1].budget;

                const sliderRange = nextPoint.slider - segment.slider;
                const budgetRange = nextPoint.budget - segment.budget;
                const sliderProgress = (value - segment.slider) / sliderRange;
                return segment.budget + (sliderProgress * budgetRange);
            }

            function convertBudgetToSliderValue(budget) {
                const segment = sliderMap.find((point, index) => {
                    const nextPoint = sliderMap[index + 1];
                    if (!nextPoint) return true;
                    return budget >= point.budget && budget <= nextPoint.budget;
                });
                const nextPoint = sliderMap[sliderMap.indexOf(segment) + 1];
                if (!nextPoint) {
                    return budget >= sliderMap[sliderMap.length - 1].budget 
                        ? sliderMap[sliderMap.length - 1].slider 
                        : segment.slider;
                }
                const sliderRange = nextPoint.slider - segment.slider;
                const budgetRange = nextPoint.budget - segment.budget;
                if (budgetRange === 0) return segment.slider;
                const budgetProgress = (budget - segment.budget) / budgetRange;
                return segment.slider + (budgetProgress * sliderRange);
            }
            
            // --- HELPER FUNCTIONS ---
            function isMobileDevice() { return ('ontouchstart' in window) || (navigator.maxTouchPoints > 0); }

            function setCookie(name, value, days) {
                let expires = "";
                if (days) {
                    const date = new Date();
                    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                    expires = "; expires=" + date.toUTCString();
                }
                document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Strict";
            }

            function getCookie(name) {
                const nameEQ = name + "=";
                const ca = document.cookie.split(';');
                for(let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                }
                return null;
            }
            
            function checkAndDisplayCookie() {
                const savedName = getCookie('userFirstName');
                if (savedName) {
                    welcomeMessageEl.innerHTML = `Welcome back, <span style="color:var(--color-primary);">${savedName}</span>! Tell us about your next project.`;
                }
            }

            function validateAndStoreName() {
                const name = document.getElementById('customer-first-name').value.trim();
                userFirstName = name;
                return name;
            }
            
            function generateEmail() {
                const firstName = document.getElementById('customer-first-name').value;
                const lastName = document.getElementById('customer-last-name').value;
                const phone = document.getElementById('customer-phone').value;
                const email = document.getElementById('customer-email').value;
                const comments = document.getElementById('customer-comments').value;

                setCookie('userFirstName', firstName, 30);

                let itemsText = 'No services selected.';
                let total = priceDisplay.textContent;

                if (servicesState['Packages'].selected) {
                    const budgetSlider = document.getElementById('budget-slider');
                    const budget = convertSliderValueToBudget(parseInt(budgetSlider.value));
                    const selectedVehicleType = document.querySelector('input[name="vehicle"]:checked').value;
                    const getPrice = (pkg) => pkg.prices[selectedVehicleType];
                    const allPackagesWithPrice = packages
                        .map(pkg => ({ ...pkg, currentPrice: getPrice(pkg) }))
                        .filter(pkg => pkg.currentPrice !== 'call');
                    const affordablePackages = allPackagesWithPrice.filter(p => p.currentPrice <= budget);
                     let activePackage;
                    if (affordablePackages.length > 0) {
                        activePackage = affordablePackages.sort((a, b) => b.currentPrice - a.currentPrice)[0];
                    } else {
                        activePackage = allPackagesWithPrice.sort((a, b) => a.currentPrice - b.currentPrice)[0];
                    }
                    itemsText = `Selected Package: ${activePackage.name} - $${activePackage.currentPrice.toLocaleString()}`;
                    total = `(From Package Slider) $${Math.round(budget).toLocaleString()}`;
                } else if (userSelections.selectedItems && userSelections.selectedItems.length > 0) {
                    itemsText = userSelections.selectedItems.map(item => {
                        const price = typeof item.price === 'number' ? ` ($${item.price.toFixed(2)})` : ` (${item.price})`;
                        return `${item.name}${price}`;
                    }).join('\n');
                }

                const subject = `WIKD Wraps Estimate Inquiry from ${firstName} ${lastName}`;
                const emailBody = `Hello WIKD Wraps Team,
I have submitted an estimate request through your online configurator. I am interested in the following services for my vehicle:
Vehicle Type: ${document.querySelector('input[name="vehicle"]:checked').value}
Total Estimate: ${total}
Selected Services:
${itemsText}
---
Customer Details:
Name: ${firstName} ${lastName}
Phone: ${phone}
Email: ${email}
Comments:
${comments || 'No additional comments provided.'}
Please get in touch with me to discuss this further.`;
                window.location.href = `mailto:sales@wikdwraps.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            }

            function updateStep(newStep) {
                const thankYouContainer = document.getElementById('thank-you-container');

                if (newStep > currentStep) {
                    let isValid = true;
                    if (currentStep === 1) {
                        const selectedServices = getSelectedServices();
                        if (selectedServices.length === 0 && newStep > 1 && !selectedPackageId) {
                            isValid = false;
                        } else {
                             if (!servicesState['Packages'].selected) {
                                for (const service of selectedServices) {
                                    if (!servicesState[service].coverage) {
                                        isValid = false;
                                        const tab = serviceTabsContainer.querySelector(`[data-service="${service}"]`);
                                        tab.style.borderColor = 'var(--color-danger)';
                                        setTimeout(() => { tab.style.borderColor = 'transparent' }, 2000);
                                        break;
                                    }
                                }
                             }
                        }
                    } else if (currentStep === 2) {
                        const contactForm = document.getElementById('step-2');
                        const requiredInputs = contactForm.querySelectorAll('[required]');
                        for(const input of requiredInputs) {
                            if(!input.value) {
                                isValid = false;
                                input.style.borderColor = 'var(--color-danger)';
                                setTimeout(() => { input.style.borderColor = 'var(--color-border)' }, 2000);
                            }
                        }
                    }
                    if (!isValid) return;
                }

                document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
                const newStepEl = document.getElementById(`step-${newStep}`);
                if (newStepEl) {
                    newStepEl.classList.add('active');
                } else { // Thank you page
                    document.getElementById('configurator-wrapper').style.display = 'none';
                    document.getElementById('image-display-container').style.display = 'none';
                    thankYouContainer.classList.remove('hidden-field');
                    thankYouContainer.classList.add('active');
                    thankYouContainer.style.flexGrow = 1;
                    const thankYouNameSpan = thankYouContainer.querySelector('.user-name');
                    const name = validateAndStoreName();
                    if (thankYouNameSpan) { thankYouNameSpan.textContent = name; }
                    window.scrollTo(0, 0);
                    return;
                }

                const totalSteps = progressSteps.length;
                const progressFraction = (newStep - 1) / (totalSteps - 1);
                const barTotalWidth = 100 - (100 / totalSteps);
                const fillWidth = progressFraction * barTotalWidth;

                progressBar.style.setProperty('--bar-start-offset', `${(100 / totalSteps) / 2}%`);
                progressBar.style.setProperty('--bar-width', `${barTotalWidth}%`);
                progressBar.style.setProperty('--progress-width', `${fillWidth}%`);

                progressSteps.forEach((step, index) => {
                    const stepNumber = index + 1;
                    step.classList.remove('active', 'completed');
                    if (stepNumber < newStep) step.classList.add('completed');
                    else if (stepNumber === newStep) step.classList.add('active');
                });
                currentStep = newStep;
                window.scrollTo(0, 0);
            }

            // --- STATE MANAGEMENT ---
            function initializeState() {
                servicesState = {};
                selectedPackageId = null;
                allServices.forEach(service => {
                    servicesState[service] = {
                        selected: false,
                        coverage: '',
                        addons: [],
                        option: null
                    };
                });
                currentlyViewingService = null;
            }

            // --- CORE LOGIC ---
            function renderTabs() {
                serviceTabsContainer.innerHTML = '';
                allServices.forEach(service => {
                    const state = servicesState[service];
                    const tab = document.createElement('div');
                    tab.className = 'service-tab';
                    tab.dataset.service = service;
                    tab.innerHTML = `${service} <span class="close-btn">&times;</span>`;
                    
                    if(state.selected) tab.classList.add('selected');
                    else tab.classList.add('available');
                    if(service === currentlyViewingService) tab.classList.add('viewing');
                    
                    serviceTabsContainer.appendChild(tab);
                });
            }

            function renderServiceContent() {
                dynamicServicesContainer.innerHTML = '';
                if (!currentlyViewingService) return;

                const service = currentlyViewingService;
                const state = servicesState[service];
                const vehicleType = document.querySelector('input[name="vehicle"]:checked').value;
                const serviceData = pricingData[vehicleType][service];

                const selectOptions = Object.keys(serviceData)
                    .map(coverage => `<option value="${coverage}" ${state.coverage === coverage ? 'selected' : ''}>${coverage}</option>`)
                    .join('');

                const serviceHtml = `
                    <div class="form-group service-section" data-service="${service}">
                        <label for="coverage-${service}">${service} Options</label>
                        <select id="coverage-${service}" name="coverage-${service}" class="coverage-select form-control" required>
                            <option value="" disabled ${!state.coverage ? 'selected' : ''}>-- Select a coverage level --</option>
                            ${selectOptions}
                        </select>
                        <div class="addons-container" id="addons-${service}" style="margin-top: 1rem;"></div>
                    </div>`;
                dynamicServicesContainer.innerHTML = serviceHtml;
                
                const selectEl = document.getElementById(`coverage-${service}`);
                if(selectEl){
                    selectEl.addEventListener('change', (e) => {
                        selectedPackageId = null;
                        servicesState[service].coverage = e.target.value;
                        servicesState[service].addons = [];
                        servicesState[service].option = null;
                        renderAddons();
                        updateImageDisplay();
                        calculateEstimate();
                    });
                }
                
                renderAddons();
            }
            
            function getQuantizedColor(hue) {
                const baseHue = 240; // Royal Blue
                const finalHue = (baseHue + parseInt(hue, 10)) % 360;

                if (finalHue >= 345 || finalHue < 15) return 'Red';
                if (finalHue >= 15 && finalHue < 45) return 'Orange';
                if (finalHue >= 45 && finalHue < 75) return 'Yellow';
                if (finalHue >= 75 && finalHue < 165) return 'Green';
                if (finalHue >= 165 && finalHue < 195) return 'Cyan';
                if (finalHue >= 195 && finalHue < 255) return 'Blue';
                if (finalHue >= 255 && finalHue < 285) return 'Purple';
                if (finalHue >= 285 && finalHue < 345) return 'Pink/Magenta';
                return 'Blue'; // Default fallback
            }

            function renderAddons() {
                if (!currentlyViewingService || currentlyViewingService === 'Packages') return;
                
                const service = currentlyViewingService;
                const state = servicesState[service];

                if (!state.coverage) return;

                const vehicleType = document.querySelector('input[name="vehicle"]:checked').value;
                const coverageData = pricingData[vehicleType][service][state.coverage];
                const addonsContainer = document.getElementById(`addons-${service}`);
                if(!addonsContainer) return;
                
                addonsContainer.innerHTML = '';

                if (coverageData.options) {
                    if (service === 'Tint') {
                        const tintOptions = Object.entries(coverageData.options);
                        const sliderId = `tint-slider-${service}-${state.coverage.replace(/\s/g, '-')}`;
                        const outputId = `tint-output-${service}-${state.coverage.replace(/\s/g, '-')}`;
                        
                        let sliderValueIndex = state.option !== null ? state.option : 1;

                        let labelsHtml = tintOptions.map(([option, optionData], index) => {
                            const tooltipText = typeof optionData === 'object' ? optionData.tooltip : null;
                            const tooltipHtml = tooltipText ? `<div class="info-tooltip">${tooltipText}</div>` : '';
                            return `<div class="slider-label info-tooltip-container" data-index="${index}">${option}${tooltipHtml}</div>`;
                        }).join('');
                        
                        const sliderHtml = `
                            <div class="form-group">
                                <label>Select Tint Percentage: <span id="${outputId}" style="color: var(--color-primary); font-weight: bold;"></span></label>
                                <div class="slider-container">
                                    <input type="range" min="0" max="${tintOptions.length - 1}" value="${sliderValueIndex}" class="tint-slider" id="${sliderId}" data-options='${JSON.stringify(tintOptions.map(o => o[0]))}'>
                                    <div class="slider-labels">${labelsHtml}</div>
                                </div>
                            </div>`;
                        addonsContainer.innerHTML = sliderHtml;

                        const slider = document.getElementById(sliderId);
                        const output = document.getElementById(outputId);
                        
                        function updateSliderView() {
                            const options = JSON.parse(slider.dataset.options);
                            const selectedValue = options[slider.value];
                            const isIllegal = ['20%', '5%'].includes(selectedValue);
                            output.textContent = selectedValue;
                            slider.classList.toggle('illegal-tint', isIllegal);
                        }
                        
                        slider.addEventListener('input', updateSliderView);
                        slider.addEventListener('change', () => {
                             selectedPackageId = null;
                             servicesState[service].option = slider.value;
                             calculateEstimate();
                        });
                        updateSliderView();
                    } else {
                        const optionsHtml = Object.entries(coverageData.options).map(([option, price]) => {
                            const uniqueId = `option-${service}-${state.coverage.replace(/\s/g, '-')}-${option.replace(/\s/g, '-')}`;
                            return `
                                <div>
                                    <input type="radio" id="${uniqueId}" name="option-${service}-${state.coverage}" value="${option}" class="choice-input" data-price="${price}" ${state.option === option ? 'checked' : ''} required>
                                    <label for="${uniqueId}" class="choice-label"><span>${option}</span></label>
                                </div>`;
                        }).join('');
                        let baseText = coverageData.base || 'Select Option';
                        addonsContainer.innerHTML = `<div class="form-group"><label>${baseText}:</label><div class="choice-group">${optionsHtml}</div></div>`;
                        
                        addonsContainer.querySelectorAll('.choice-input').forEach(input => {
                            input.addEventListener('change', (e) => {
                                selectedPackageId = null;
                                servicesState[service].option = e.target.value;
                                calculateEstimate();
                            });
                        });
                    }
                }
                
                if (coverageData.addons) {
                    const addonsHtml = Object.keys(coverageData.addons).map(addon => {
                        const price = coverageData.addons[addon];
                        const uniqueId = `addon-${service}-${state.coverage.replace(/\s/g, '-')}-${addon.replace(/\s/g, '-')}`;
                        return `
                            <div>
                                <input type="checkbox" id="${uniqueId}" name="addon-${addon}" class="addon choice-input" data-addon-name="${addon}" data-price="${price}" ${state.addons.includes(addon) ? 'checked' : ''}>
                                <label for="${uniqueId}" class="choice-label"><span>${addon}</span></label>
                            </div>`;
                    }).join('');
                    const existingContent = addonsContainer.innerHTML;
                    addonsContainer.innerHTML = existingContent + `<div class="form-group" style="margin-top: 1rem;"><label>Available Add-ons:</label><div class="choice-group">${addonsHtml}</div></div>`;
                    
                    addonsContainer.querySelectorAll('.addon').forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            selectedPackageId = null;
                            const addonName = e.target.dataset.addonName;
                            if (e.target.checked) {
                                if (!servicesState[service].addons.includes(addonName)) {
                                    servicesState[service].addons.push(addonName);
                                }
                            } else {
                                servicesState[service].addons = servicesState[service].addons.filter(a => a !== addonName);
                            }
                            calculateEstimate();
                        });
                    });
                } else if (service === 'Vinyl' && state.coverage === 'Color Change') {
                        const sliderId = `hue-slider-${service}`;
                        const hueValue = state.option || 0;

                        const sliderHtml = `
                            <div class="form-group">
                                <label for="${sliderId}">Adjust Wrap Color</label>
                                <div class="slider-container">
                                    <input type="range" min="0" max="360" value="${hueValue}" class="hue-slider" id="${sliderId}">
                                </div>
                            </div>`;
                        addonsContainer.innerHTML = sliderHtml;

                        const slider = document.getElementById(sliderId);
                        slider.addEventListener('input', (e) => {
                            coverageImageBase.style.filter = `hue-rotate(${e.target.value}deg)`;
                        });
                        slider.addEventListener('change', (e) => {
                            selectedPackageId = null;
                            servicesState[service].option = e.target.value;
                            calculateEstimate();
                        });
                }
            }
            
            function getApplicableDiscounts(state) {
                const appliedDiscounts = [];
                const appliedDiscountIds = new Set();

                const hasPPF = state['PPF']?.selected && state['PPF']?.coverage;
                const hasTint = state['Tint']?.selected && state['Tint']?.coverage;
                const hasCoating = state['Coating']?.selected && state['Coating']?.coverage === 'Paint';

                if (hasPPF && hasTint && hasCoating) {
                    appliedDiscounts.push({ name: 'PPF, Tint, & Coating Bundle', value: -395 });
                    appliedDiscountIds.add('ppf-tint-coating');
                }

                if (hasPPF && hasCoating && !appliedDiscountIds.has('ppf-tint-coating')) {
                    appliedDiscounts.push({ name: 'PPF & Coating Bundle', value: -295 });
                    appliedDiscountIds.add('ppf-coating');
                }
                
                const isAdvancedCoating = hasCoating &&
                                          state['Coating'].addons.includes('Add Wheels (Face & Barrels)') &&
                                          state['Coating'].addons.includes('Add Windshield');

                if (isAdvancedCoating) {
                    appliedDiscounts.push({ name: 'Coating Bundle', value: -150 });
                    appliedDiscounts.push({ name: 'FREE Trim Coating', value: 0 }); 
                    appliedDiscountIds.add('coating-bundle');
                }

                return appliedDiscounts;
            }

            function calculateEstimate() {
                const vehicleType = document.querySelector('input[name="vehicle"]:checked').value;
                const nonPackageServicesSelected = allServices.some(s => s !== 'Packages' && servicesState[s].selected);

                if (currentlyViewingService === 'Packages' && !nonPackageServicesSelected && !selectedPackageId) {
                    priceDisplay.textContent = '$0.00';
                    priceDisplay.classList.remove('consultation');
                    summaryItemsList.innerHTML = '';
                    toggleSummaryBtn.classList.add('hidden-field');
                    summaryBreakdown.classList.remove('expanded');
                    estimateSummaryEl.classList.add('hidden-field');
                    return;
                }
                
                estimateSummaryEl.classList.remove('hidden-field');
                
                let total = 0;
                let isConsultationNeeded = false;
                userSelections.selectedItems = [];

                if(selectedPackageId) {
                     const pkg = packages.find(p => p.id === selectedPackageId);
                     const breakdown = packageBreakdowns[selectedPackageId] ? packageBreakdowns[selectedPackageId][vehicleType] : null;
                     
                     if (pkg) {
                        const price = pkg.prices[vehicleType];
                        if (typeof price === 'number') {
                             total = price;
                             if(breakdown) {
                                userSelections.selectedItems = [...breakdown];
                             } else {
                                // Fallback for simple packages without detailed breakdown
                                 userSelections.selectedItems.push({ name: pkg.name, price: price });
                             }
                        } else {
                            isConsultationNeeded = true;
                        }
                     }
                } else {
                    for (const service of allServices) {
                        if (service === 'Packages') continue;
                        const state = servicesState[service];
                        if (!state.selected || !state.coverage) continue;
                        
                        const serviceData = pricingData[vehicleType][service];
                        const coverageData = serviceData[state.coverage];
                        let serviceItemName = `${service} - ${state.coverage}`;
                        
                        if (typeof coverageData.price === 'string') {
                            isConsultationNeeded = true;
                            userSelections.selectedItems.push({ name: serviceItemName, price: 'Call For Free Consultation' });
                        } else {
                            let basePrice = coverageData.price || 0;
                            
                            if(coverageData.options) {
                                let optionName = '';
                                if(service === 'Tint') {
                                    const tintOptions = Object.keys(coverageData.options);
                                    optionName = tintOptions[state.option || 1];
                                } else if(service === 'Coating' && state.option) {
                                    optionName = state.option;
                                    const optionPrice = coverageData.options[optionName];
                                    if (typeof optionPrice === 'string') {
                                        isConsultationNeeded = true;
                                    } else {
                                        basePrice += optionPrice;
                                    }
                                }
                                if(optionName) serviceItemName += ` - ${optionName}`;
                            }
                             if(service === 'Vinyl' && state.coverage === 'Color Change' && state.option !== null) {
                                const colorName = getQuantizedColor(state.option);
                                serviceItemName += ` - ${colorName}`;
                            }
                            
                            if (!isConsultationNeeded) total += basePrice;
                            userSelections.selectedItems.push({ name: serviceItemName, price: basePrice });
                        }
                         
                        if (coverageData.addons) {
                            state.addons.forEach(addon => {
                                const addonPrice = coverageData.addons[addon];
                                if (typeof addonPrice === 'string') {
                                    isConsultationNeeded = true;
                                    userSelections.selectedItems.push({ name: `+ ${addon}`, price: 'Call For Free Consultation' });
                                } else {
                                    if (!isConsultationNeeded) total += addonPrice;
                                    userSelections.selectedItems.push({ name: `+ ${addon}`, price: addonPrice });
                                }
                            });
                        }
                    }
                
                    const discounts = getApplicableDiscounts(servicesState);
                    discounts.forEach(discount => {
                        total += discount.value;
                        userSelections.selectedItems.push({ name: discount.name, price: discount.value });
                    });
                }
                

                const selectedServicesCount = Object.values(servicesState).filter(s => s.selected && s.coverage).length;
                if (isConsultationNeeded) {
                    priceDisplay.textContent = 'Call For Free Consultation';
                    priceDisplay.classList.add('consultation');
                    if (total > 0) {
                        priceDisplay.textContent += ` + $${total.toFixed(2)}`;
                    }
                } else if (selectedServicesCount === 0 && !selectedPackageId) {
                    priceDisplay.textContent = '$0.00';
                    priceDisplay.classList.remove('consultation');
                } else {
                    priceDisplay.textContent = `$${total.toFixed(2)}`;
                    priceDisplay.classList.remove('consultation');
                }
                selectionsNextBtn.disabled = selectedServicesCount === 0 && selectedPackageId === null;

                summaryItemsList.innerHTML = '';
                if (userSelections.selectedItems.length > 0) {
                    toggleSummaryBtn.classList.remove('hidden-field');
                    userSelections.selectedItems.forEach(item => {
                        const li = document.createElement('li');
                        const isDiscount = typeof item.price === 'number' && item.price < 0;
                        const isFreebie = typeof item.price === 'number' && item.price === 0;

                        let priceText = 'Included';
                        if (typeof item.price === 'string') {
                           priceText = item.price;
                        } else if (isDiscount) {
                            priceText = `-$${Math.abs(item.price).toFixed(2)}`;
                        } else if (!isFreebie) {
                            priceText = `$${item.price.toFixed(2)}`;
                        }
                        
                        li.innerHTML = `<span class="item-name">${item.name}</span> <span class="item-price">${priceText}</span>`;
                        
                        if (isDiscount || isFreebie) {
                            li.querySelector('.item-price').classList.add('discount');
                            li.querySelector('.item-name').classList.add('discount');
                        }
                        summaryItemsList.appendChild(li);
                    });
                } else {
                    toggleSummaryBtn.classList.add('hidden-field');
                    summaryBreakdown.classList.remove('expanded');
                    toggleSummaryBtn.classList.remove('expanded');
                }
            }
            
            // --- PACKAGE SLIDER RENDER FUNCTIONS ---
             function renderPackageSliderLabels(container) {
                const labelsContainer = container.querySelector('#package-slider-labels');
                if (!labelsContainer) return;
                labelsContainer.innerHTML = '';
                const labelValues = [500, 2500, 7500, 15000];
                labelValues.forEach(budget => {
                    const sliderValue = convertBudgetToSliderValue(budget);
                    const percentage = (sliderValue / 1000) * 100;
                    const label = document.createElement('span');
                    label.className = 'absolute text-xs transform -translate-x-1/2';
                    label.style.color = 'var(--color-text-muted)';
                    label.textContent = `$${(budget / 1000).toFixed(1)}K`;
                    label.style.left = `${percentage}%`;
                    labelsContainer.appendChild(label);
                });
            }

            function renderPackageCards(container) {
                const budgetSlider = container.querySelector('#budget-slider');
                const budgetValue = container.querySelector('#budget-value');
                const packageContainer = container.querySelector('#package-container');
                const protectionMeterFill = container.querySelector('#protection-meter-fill');
                const protectionLevelTag = container.querySelector('#protection-level-tag');
                
                if(!budgetSlider || !packageContainer) return;

                const budget = convertSliderValueToBudget(parseInt(budgetSlider.value));
                const selectedVehicleType = document.querySelector('input[name="vehicle"]:checked').value;
                
                packageContainer.innerHTML = '';
                
                const getPrice = (pkg) => pkg.prices[selectedVehicleType];

                const allPackagesWithPrice = packages
                    .map(pkg => ({ ...pkg, currentPrice: getPrice(pkg) }))
                    .filter(pkg => pkg.currentPrice !== 'call');
                    
                const callForEstimatePackages = packages.filter(pkg => getPrice(pkg) === 'call');

                let activePackage;
                const affordablePackages = allPackagesWithPrice.filter(p => p.currentPrice <= budget);

                if (affordablePackages.length > 0) {
                    activePackage = affordablePackages.sort((a, b) => b.currentPrice - a.currentPrice)[0];
                } else {
                    activePackage = allPackagesWithPrice.sort((a, b) => a.currentPrice - b.currentPrice)[0];
                }
                
                if (activePackage) {
                    updateImageDisplay(activePackage);
                }

                const priceSortedPackages = [...allPackagesWithPrice].sort((a, b) => a.currentPrice - b.currentPrice);
                const activePackageIndex = priceSortedPackages.findIndex(p => p.id === activePackage.id);

                const packagesToRender = [];
                if (activePackage) {
                    packagesToRender.push(activePackage);
                }

                let nextPackage;
                if (activePackageIndex < priceSortedPackages.length - 1) {
                    nextPackage = priceSortedPackages[activePackageIndex + 1];
                } else if (callForEstimatePackages.length > 0) {
                     nextPackage = { ...callForEstimatePackages[0], currentPrice: 'Call for Estimate' };
                }
                if (nextPackage) {
                    packagesToRender.push(nextPackage);
                }
                
                budgetValue.textContent = `$${Math.round(budget).toLocaleString('en-US')}`;
                if (activePackage) {
                    protectionMeterFill.style.width = `${activePackage.protectionLevel}%`;
                    protectionLevelTag.textContent = activePackage.tag;

                    const tagColorClasses = {
                        'Tint': 'text-blue-400',
                        'Coating': 'text-green-400',
                        'PPF': 'text-yellow-400',
                        'Bundle': 'text-purple-400'
                    };
                    protectionLevelTag.className = `ml-2 font-bold ${tagColorClasses[activePackage.tag] || 'text-gray-400'}`;
                }


                packagesToRender.forEach((pkg, index) => {
                    const isActiveCard = index === 0;
                    
                    const displayPrice = typeof pkg.currentPrice === 'number'
                        ? `$${pkg.currentPrice.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`
                        : pkg.currentPrice;

                    const tagBgClasses = {
                        'Tint': 'bg-blue-900 text-blue-300',
                        'Coating': 'bg-green-900 text-green-300',
                        'PPF': 'bg-yellow-900 text-yellow-300',
                        'Bundle': 'bg-purple-900 text-purple-300'
                    };
                    
                    const [tagBg, tagText] = (tagBgClasses[pkg.tag] || 'bg-gray-700 text-gray-200').split(' ');

                    const packageCard = document.createElement('div');
                    packageCard.className = `package-card rounded-lg border shadow-sm overflow-hidden ${isActiveCard ? 'active' : ''}`;

                    packageCard.innerHTML = `
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-bold text-white">${pkg.name}</h3>
                                <span class="${tagBg} ${tagText} text-xs font-semibold px-2.5 py-0.5 rounded-full">${pkg.tag}</span>
                            </div>
                            <div class="mb-4">
                                <p class="text-3xl font-bold" style="color: var(--color-primary);">${displayPrice}</p>
                                <p class="text-sm" style="color: var(--color-text-muted);">${pkg.tagline}</p>
                            </div>
                            
                            <div class="mb-4">
                                <button class="parts-toggle-btn w-full flex justify-between items-center py-2 px-4 rounded-lg transition">
                                    <span class="font-medium">Package Details</span>
                                    <i class="fas fa-chevron-down text-xs transition-transform"></i>
                                </button>
                                <div class="parts-content mt-3 pl-2 hidden">
                                    <p class="mb-3">${pkg.description}</p>
                                    ${pkg.discounts && pkg.discounts.length > 0 ? `
                                    <h4 class="font-semibold text-green-400 text-sm mb-1">Applicable Discounts:</h4>
                                    <ul class="list-disc text-green-400 space-y-1 pl-5 text-sm">
                                        ${pkg.discounts.map(d => `<li>${d}</li>`).join('')}
                                    </ul>` : ''}
                                </div>
                            </div>
                             <button class="package-btn mt-4 select-package-btn" data-package-id="${pkg.id}">
                                <i class="fas fa-check-circle mr-2"></i> Select Package
                            </button>
                        </div>`;
                    packageContainer.appendChild(packageCard);

                    const toggleBtn = packageCard.querySelector('.parts-toggle-btn');
                    const partsContent = packageCard.querySelector('.parts-content');
                    const toggleIcon = packageCard.querySelector('.parts-toggle-btn i');
                    toggleBtn.addEventListener('click', () => {
                        partsContent.classList.toggle('hidden');
                        toggleIcon.classList.toggle('rotate-180');
                    });
                });

                // Add event listeners to the new select buttons
                container.querySelectorAll('.select-package-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const packageId = e.currentTarget.dataset.packageId;
                        selectPackage(packageId);
                    });
                });
            }

            function renderPackagesView(container) {
                container.innerHTML = `
                    <div class="package-slider-container">
                        <div class="bg-transparent rounded-lg p-0 mb-8" id="control-panel">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                                <div class="mb-4 md:mb-0">
                                    <h3 class="text-lg font-semibold mb-3 uppercase" style="color: var(--color-text);">Your Budget</h3>
                                </div>
                                <div class="text-right">
                                    <span id="budget-value" class="text-3xl font-bold" style="color: var(--color-primary);">$2,500</span>
                                </div>
                            </div>
                            <div class="relative">
                                <input type="range" min="0" max="1000" step="1" value="200" class="w-full h-2 rounded-lg appearance-none cursor-pointer budget-slider-input" id="budget-slider">
                                <div id="package-slider-labels" class="relative mt-2 h-4"></div>
                            </div>
                        </div>
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-semibold uppercase" style="color: var(--color-text);">Protection Level</h3>
                                <span id="protection-level-tag" class="ml-2 font-bold">Basic</span>
                            </div>
                            <div class="flex justify-between text-xs" style="color: var(--color-text-muted);"><span class="uppercase">Basic</span><span class="uppercase">Ultimate</span></div>
                            <div class="protection-meter-bg relative h-2 rounded">
                                <div id="protection-meter-fill" class="protection-meter-fill" style="width: 5%"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="package-container"></div>
                    </div>
                `;
                
                const budgetSlider = container.querySelector('#budget-slider');
                budgetSlider.addEventListener('input', () => renderPackageCards(container));
                
                renderPackageSliderLabels(container);
                renderPackageCards(container);
            }

            function handleTabClick(e) {
                const target = e.target;
                const tab = target.closest('.service-tab');
                if (!tab) return;
                
                const service = tab.dataset.service;

                if (target.classList.contains('close-btn')) {
                    e.stopPropagation();
                    selectedPackageId = null;
                    servicesState[service].selected = false;
                    servicesState[service].coverage = '';
                    servicesState[service].addons = [];
                    servicesState[service].option = null;

                    if(currentlyViewingService === service) {
                        currentlyViewingService = Object.keys(servicesState).find(s => servicesState[s].selected) || 'Packages';
                    }
                } else {
                    if (currentlyViewingService === 'Packages' && service !== 'Packages') {
                        selectedPackageId = null;
                    }

                    if (service !== 'Packages' && !servicesState[service].selected) {
                        servicesState[service].selected = true;
                    } else if (service === 'Packages') {
                        // Deselect other services when going back to packages
                        initializeState();
                        servicesState['Packages'].selected = true;
                    }
                    currentlyViewingService = service;
                }
                
                // If all individual services are deselected, go back to packages
                if (!allServices.slice(1).some(s => servicesState[s].selected)) {
                    servicesState['Packages'].selected = true;
                    if(document.activeElement.closest('.close-btn')) {
                        currentlyViewingService = 'Packages';
                    }
                } else {
                     servicesState['Packages'].selected = false;
                }

                renderTabs();

                if(currentlyViewingService === 'Packages') {
                    renderPackagesView(dynamicServicesContainer);
                } else {
                    renderServiceContent();
                }
                
                calculateEstimate();
                updateImageDisplay();
            }

            function getSelectedServices() {
                return allServices.filter(s => servicesState[s].selected);
            }

            function updateImageDisplay(activePackage = null) {
                // Reset styles first
                coverageImageBase.style.filter = 'none';
                coverageImageOverlay.style.display = 'none';
                coverageImageOverlay.style.filter = 'none';
                coverageImageOverlay.style.mixBlendMode = 'normal';
                coverageImageOverlay.style.opacity = '1';

                const packageToDisplay = activePackage || packages.find(p => p.id === selectedPackageId);

                if (packageToDisplay?.isF1) {
                    coverageImageBase.src = ppfImageMap['Full Car'];
                    coverageImageOverlay.src = ppfImageMap['Track Pack'];
                    coverageImageOverlay.style.display = 'block';
                    coverageImageOverlay.style.opacity = '0.7';
                    coverageImageOverlay.style.mixBlendMode = 'lighten';
                    coverageImageOverlay.style.filter = 'hue-rotate(180deg) saturate(3)';
                    return;
                }

                if (packageToDisplay?.ppfCoverage) {
                    coverageImageBase.src = ppfImageMap[packageToDisplay.ppfCoverage] || ppfImageMap['Partial'];
                    return;
                }

                // Fallback to service-based logic for manual customization
                const hasPPF = servicesState['PPF'].selected && servicesState['PPF'].coverage;
                const hasVinyl = servicesState['Vinyl'].selected && servicesState['Vinyl'].coverage === 'Color Change';

                if (hasPPF) {
                    coverageImageBase.src = ppfImageMap[servicesState['PPF'].coverage] || ppfImageMap['Partial'];
                    return;
                }

                if (hasVinyl) {
                    coverageImageBase.src = ppfImageMap['Full Car']; // Vinyl uses the full car image for hue rotation
                    const hue = servicesState['Vinyl'].option || 0;
                    coverageImageBase.style.filter = `hue-rotate(${hue}deg)`;
                    return;
                }

                // Default image
                coverageImageBase.src = 'https://cdn.shopify.com/s/files/1/0671/4635/0805/files/image.png?v=1757352859';
            }


            function selectPackage(packageId) {
                const selection = packageSelections[packageId];
                if (!selection) return;
                
                initializeState();
                selectedPackageId = packageId;

                Object.keys(selection).forEach(service => {
                    const serviceSelection = selection[service];
                    servicesState[service] = {
                        ...servicesState[service], // Keep default structure
                        ...serviceSelection
                    };
                });
                
                // Keep viewing the Packages tab
                servicesState['Packages'].selected = true;
                currentlyViewingService = 'Packages';

                // Update UI based on new state
                renderTabs(); // This will show the included services as selected
                calculateEstimate(); // This will now work correctly and show the summary
                updateImageDisplay();
            }
            
            // This function modifies the pricingData object to support complex packages as addons
            function augmentPricingData() {
                 Object.keys(pricingData).forEach(vehicleType => {
                    const tintData = pricingData[vehicleType].Tint;
                    const coatingData = pricingData[vehicleType].Coating;

                    // Add addons to Tint
                    if (tintData['Full Car']) {
                        if (!tintData['Full Car'].addons) tintData['Full Car'].addons = {};
                        tintData['Full Car'].addons['Add Windshield'] = tintData['Windshield']?.price || 450;
                        tintData['Full Car'].addons['Add Sunroof'] = 295; // Estimated price
                    }

                    // Add addons to Coating
                    if (coatingData['Paint']) {
                         if (!coatingData.Paint.addons) coatingData.Paint.addons = {};
                         coatingData.Paint.addons['Add Wheels (Face & Barrels)'] = coatingData.Wheels?.options['Face & Barrels'] || 400;
                         coatingData.Paint.addons['Add Windshield'] = coatingData.Windshield?.price || 155;
                    }
                });
            }


            // --- INITIALIZATION & EVENT LISTENERS ---
            function initializeApp() {
                augmentPricingData();
                initializeState();
                
                // Default to packages view
                servicesState['Packages'].selected = true;
                currentlyViewingService = 'Packages';

                renderTabs();
                renderPackagesView(dynamicServicesContainer);
                calculateEstimate();
                checkAndDisplayCookie();
                
                document.querySelectorAll('input[name="vehicle"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        
                        const wasPackageSelected = !!selectedPackageId;
                        const previousService = currentlyViewingService;

                        // Recalculate based on current state before resetting
                        if(wasPackageSelected) {
                            const tempState = JSON.parse(JSON.stringify(servicesState));
                             const tempPkgId = selectedPackageId;
                            initializeState();
                            servicesState = tempState;
                            selectedPackageId = tempPkgId;
                        } else {
                            const wereServicesSelected = allServices.some(s => s !== 'Packages' && servicesState[s].selected);
                            initializeState();
                             if(wereServicesSelected) {
                                servicesState[previousService].selected = true;
                                currentlyViewingService = previousService;
                            } else {
                                servicesState['Packages'].selected = true;
                                currentlyViewingService = 'Packages';
                            }
                        }
                        
                        renderTabs();

                        if (currentlyViewingService === 'Packages') {
                            renderPackagesView(dynamicServicesContainer);
                        } else {
                            renderServiceContent();
                        }
                        
                        calculateEstimate();
                        updateImageDisplay();
                    });
                });
                serviceTabsContainer.addEventListener('click', handleTabClick);

                nextBtns.forEach(btn => btn.addEventListener('click', () => updateStep(currentStep + 1)));
                prevBtns.forEach(btn => btn.addEventListener('click', () => updateStep(currentStep - 1)));
                submitFormBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (form.reportValidity()) {
                        generateEmail();
                        setTimeout(() => {
                            updateStep(3);
                        }, 500);
                    }
                });
                
                toggleSummaryBtn.addEventListener('click', () => {
                    summaryBreakdown.classList.toggle('expanded');
                    toggleSummaryBtn.classList.toggle('expanded');
                });

                callLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        if (!isMobileDevice()) {
                            e.preventDefault();
                            e.stopPropagation();
                            const tooltip = this.parentElement.querySelector('.qr-tooltip');
                            if (!tooltip) return;
                            const canvas = tooltip.querySelector('.qr-code-canvas');
                            const isActive = tooltip.classList.contains('active');
                            
                            document.querySelectorAll('.qr-tooltip.active').forEach(activeTooltip => {
                                activeTooltip.classList.remove('active');
                            });

                            if (!isActive) {
                                tooltip.classList.add('active');
                                if (!canvas.dataset.rendered) {
                                    QRCode.toCanvas(canvas, `tel:${phoneNumber}`, {
                                        width: 150,
                                        margin: 0,
                                        color: {
                                            dark: '#FFB700',
                                            light: '#141414'
                                        }
                                    }, function (error) {
                                        if (error) console.error(error);
                                        canvas.dataset.rendered = 'true';
                                    });
                                }
                            }
                        }
                    });
                });

                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.call-link-container')) {
                        document.querySelectorAll('.qr-tooltip.active').forEach(tooltip => {
                            tooltip.classList.remove('active');
                        });
                    }
                });
            }

            initializeApp();

        });
    </script>
</body>
</html>

